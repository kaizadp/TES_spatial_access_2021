---
title: "Spatial Access -- Results"
output: github_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      collapse = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      comment = "#>",
                      fig.path = ("markdown/results/"))
```

```{r load}
library(here)
source(here("code/0-packages.R"))
library(gt)
library(lme4)
library(multcomp)



theme_set(theme_bw())
pal = pnw_palette("Bay", 3)

```
### H: C amendments will cause a depletion of aromatic molecules, especially in fine pores

```{r files}
# data_long = read.csv(here("data/processed/fticr_long_core.csv.gz"))
# data = read.csv(here("data/processed/fticr_long_key.csv.gz")) %>% 
#    #filter(n>2) %>% 
#    mutate(Homogenization = factor(Homogenization, levels = c("Intact", "Homogenized")),
#          Amendments = factor(Amendments, levels = c("control", "C", "N"))) %>% 
#    filter(!Suction==15)
# data_long_trt = read.csv(here("data/processed/fticr_long_trt.csv.gz"))

meta = read.csv(here("data/processed/fticr_meta.csv"))
meta_hcoc = 
  meta %>% 
  dplyr::select(formula, HC, OC)
```

```{r load_files}
fticr_key = read.csv(here("data/processed/fticr_key.csv")) %>% 
   distinct(SampleAssignment, Moisture, Wetting, Amendments, Suction, Homogenization)

fticr_data_key = read.csv(here("data/processed/fticr_long_key.csv.gz")) %>% 
     mutate(Homogenization = factor(Homogenization, levels = c("Intact", "Homogenized")),
            Amendments = factor(Amendments, levels = c("control", "C", "N")),
            Moisture = factor(Moisture, levels = c("fm", "drought")),
            Wetting = factor(Wetting, levels = c("precip", "groundw"))) 

meta_classes = 
  meta %>% 
  dplyr::select(formula, class)
```

```{r fticr_peaks}
peaks_distinct = 
   fticr_data_key %>% 
   group_by(SampleAssignment) %>% 
   distinct(formula)

peakcounts = 
   peaks_distinct %>% 
   left_join(meta_classes, by = "formula") %>% 
  group_by(SampleAssignment, class) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  group_by(SampleAssignment) %>% 
  dplyr::mutate(total = sum(n)) %>% 
  spread(class, n) %>% 
  pivot_longer(-c(SampleAssignment),
               names_to = "class") %>% 
  ungroup() %>% 
  group_by(SampleAssignment, class) %>% 
   dplyr::summarize(peaks = as.integer(mean(value))) %>% 
  #spread(name, peaks) %>% 
   left_join(fticr_key, by = "SampleAssignment") %>% 
   ungroup %>% 
  dplyr::select(-SampleAssignment) %>% 
   mutate(Amendments = factor(Amendments, 
                              levels = c("control", "C", "N")),
          class = factor(class, levels = 
                          c("aliphatic", "aliphatic+N","unsaturated","aromatic","condensed_arom", "other", "total")))
```

```{r table_aromatic_peak_counts1, eval=FALSE}
peakcounts %>% 
   filter(class %in% c("aromatic", "condensed_arom") & !Suction == 15 & Homogenization=="Intact") %>%
   group_by(Suction, Moisture, Wetting, Amendments, Homogenization) %>% 
   summarise(peaks=sum(peaks)) %>% 
   ungroup() %>% 
   #select(-class) %>% 
   mutate(var = paste0(Suction,"-",Amendments),
          var = factor(var, levels = c("1.5-control", "1.5-C", "1.5-N",
                                       "50-control", "50-C", "50-N")),
          Homogenization = factor(Homogenization, levels = c("Intact", "Homogenized"))) %>% 
   dplyr::select(-Suction,-Amendments) %>% 
   spread(var, peaks) %>% 
   gt(rowname_col = "row", groupname_col = "Homogenization") %>% 
   tab_spanner(label = "1.5 kPa", columns = contains("1.5")) %>% 
   tab_spanner(label = "50 kPa", columns = contains("50")) %>% 
   tab_header(
    title = md("Distinct Aromatic Peaks Present")
  )
```

```{r}
aromatic_counts_by_core = 
  fticr_data_key %>% 
  filter(!Suction == 15) %>%
  left_join(meta_classes, by = "formula") %>% 
  filter(class %in% c("aromatic", "condensed_arom")) %>% 
  group_by(Core, Suction, Moisture, Wetting, Amendments, Homogenization) %>% 
  summarise(arom_peaks=sum(presence)) %>% 
  ungroup() 

aromatic_counts_by_core_intact = 
  aromatic_counts_by_core %>% 
  filter(Homogenization=="Intact")

  ## aromatic_counts_by_core %>% 
  ##   ggplot( aes(x = Amendments, y = arom_peaks))+
  ##   geom_point()+
  ##   facet_grid(Suction ~ Moisture+Wetting)+
  ##   labs(title = "aromatic peaks",
  ##        subtitle = "AImod > 0.5")

arom_label = tribble(
  ~Suction, ~Amendments, ~arom_peaks, ~label,
  1.5, "control", 400, "b",
  1.5, "C", 600, "a",
  1.5, "N", 400, "ab",
  50, "control", 650, "b",
  50, "C", 900, "a",
  50, "N", 450, "b"
  ) %>% 
  mutate(Wetting="precip")


aromatic_counts_by_core_intact %>% 
  ggplot( aes(x = Amendments, y = arom_peaks, color = Moisture, shape = Wetting))+
  geom_boxplot(fill=NA, color = "grey", aes(group=Amendments))+
  geom_point(size=2, position = position_dodge(width = 0.7))+
  facet_grid(.~Suction)+
  labs(title = "aromatic peaks in intact cores",
       subtitle = "AImod > 0.5")+
  geom_text(data = arom_label, aes(label = label), color = "black")+
#  theme(panel.grid = element_blank())+
  NULL

```

```{r, eval=FALSE}
library(lme4)
library(multcomp)

l = lmer(
    arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture), REML = TRUE,
    data = aromatic_counts_by_core_intact
    )
print("arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture)")
car::Anova(l, type="II")
aromatic_counts_by_core_intact %>% 
  group_by(Amendments) %>% 
  summarise(peaks = mean(arom_peaks)) %>% 
  spread(Amendments, peaks) 
cld(glht(l, mcp(Amendments="Tukey")))
```

```{r, eval=FALSE}

l1 = lmer(
    arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture), REML = TRUE,
    data = aromatic_counts_by_core %>% filter(Suction==50)
    )
print("arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture)")
car::Anova(l1, type="II")
aromatic_counts_by_core %>% 
  filter(Suction==50) %>% 
  group_by(Amendments) %>% 
  summarise(peaks = mean(arom_peaks)) %>% 
  spread(Amendments, peaks) 
cld(glht(l1, mcp(Amendments="Tukey")))


l2 = lmer(
    arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture), REML = TRUE,
    data = aromatic_counts_by_core %>% filter(Suction==1.5),
    control=lmerControl(check.conv.singular = .makeCC(action = "ignore",  tol = 1e-4))
    )
print("arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture)")
car::Anova(l2, type="II")
aromatic_counts_by_core %>% 
  filter(Suction==1.5) %>% 
  group_by(Amendments) %>% 
  summarise(peaks = mean(arom_peaks)) %>% 
  spread(Amendments, peaks) 
cld(glht(l2, mcp(Amendments="Tukey")))
```

### H: Homogenization will increase (a) total peaks, (b) diversity of peaks, (c) aromatic peaks

---


**Table: how do different treatments alter aromatic peaks?**

```{r AROM_AMEND, eval=FALSE}
l = lmer(
    arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture) + (1|Suction), REML = TRUE,
    data = aromatic_counts_by_core_intact
    )
print("arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture)")
car::Anova(l, type="II")
aromatic_counts_by_core_intact %>% 
  group_by(Amendments) %>% 
  summarise(peaks = mean(arom_peaks)) %>% 
  spread(Amendments, peaks) 
cld(glht(l, mcp(Amendments="Tukey")))
```

```{r AROM_SUCTION, eval=FALSE}
l = lmer(
    arom_peaks ~ as.character(Suction)  + (1|Wetting) + (1|Moisture) + (1|Amendments), REML = TRUE,
    data = aromatic_counts_by_core_intact
    )
print("arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture)")
car::Anova(l, type="II")
aromatic_counts_by_core_intact %>% 
  group_by(Suction) %>% 
  summarise(peaks = mean(arom_peaks)) %>% 
  spread(Suction, peaks) 
#cld(glht(l, mcp(Suction="Tukey")))
```

```{r AROM_MOISTURE, eval=FALSE}
l = lmer(
    arom_peaks ~ Moisture  + (1|Wetting) + (1|Amendments) + (1|Suction), REML = TRUE,
    data = aromatic_counts_by_core_intact
    )
print("arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture)")
car::Anova(l, type="II")
aromatic_counts_by_core_intact %>% 
  group_by(Moisture) %>% 
  summarise(peaks = mean(arom_peaks)) %>% 
  spread(Moisture, peaks) 
cld(glht(l, mcp(Moisture="Tukey")))
```

```{r AROM_WETTING, eval=FALSE}
l = lmer(
    arom_peaks ~ Wetting  + (1|Moisture) + (1|Amendments) + (1|Suction), REML = TRUE,
    data = aromatic_counts_by_core_intact
    )
print("arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture)")
car::Anova(l, type="II")
aromatic_counts_by_core_intact %>% 
  group_by(Wetting) %>% 
  summarise(peaks = mean(arom_peaks)) %>% 
  spread(Wetting, peaks) 
cld(glht(l, mcp(Wetting="Tukey")))
```

```{r AROM_HOMO, eval=FALSE}
l = lmer(
    arom_peaks ~ Homogenization  + (1|Moisture) + (1|Amendments) + (1|Suction) + (1|Wetting), REML = TRUE,
    data = aromatic_counts_by_core,
    control=lmerControl(check.conv.singular = .makeCC(action = "ignore",  tol = 1e-4))

    )
print("arom_peaks ~ Amendments  + (1|Wetting) + (1|Moisture)")
car::Anova(l, type="II")
aromatic_counts_by_core %>% 
  group_by(Homogenization) %>% 
  summarise(peaks = mean(arom_peaks)) %>% 
  spread(Homogenization, peaks) 
cld(glht(l, mcp(Homogenization="Tukey")))
```

|                         |                 |                   |             |
|--------                 |-------          |-------            |------       |
suction (p < 0.001)*      | 1.5 kPa: 209 b  | 50 kPa: 371 a     |
moisture (p = 0.004)*     | fm: 245 b       | drought: 335 a    |
wetting (p = 0.008)*      | precip:  328 a  | groundw: 244 b    |
amendments (p = 0.001)*   | control: 255 b  | C: 372 a          | N: 240 b    |
homogenization (p < 0.001)| intact: 287 b   | homogenized: 507 b|

Note: * intact cores only